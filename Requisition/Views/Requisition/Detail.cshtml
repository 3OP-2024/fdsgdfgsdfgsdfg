@model Requisition.Models.WH_PR_RequisitionHeader

@{ string Disable = ""; var DisableDDlType = false;
    if (Model?.SYS_Status != "P01" && !string.IsNullOrEmpty(Model?.RunningID))
    {
        Disable = "disabled";
        DisableDDlType = true;
    }
    Requisition.Models.Search Search = ViewBag.Search ?? null;
    if (!string.IsNullOrEmpty(Model?.RequisitionType)) { Search.TypeID = Model?.RequisitionType; }
    var approve1 = (Model?.SYS_Status == "P02" && ViewBag.approve1 == true ? false : true);

}


@section Css{
    @*<link href="~/css/icons/select2.css" rel="stylesheet" />
        <link href="~/assets/plugins/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css" rel="stylesheet" />*@
    <style>
        .jobcode-input {
            cursor: pointer;
        }

        .editable-input[readonly] {
            cursor: pointer;
            border-bottom: 1px dashed #ccc;
            transition: border-color .2s;
        }

            .editable-input[readonly]:hover {
                border-color: #007bff;
            }

        .edit-icon {
            opacity: 0.4;
            pointer-events: none;
            transition: opacity .2s;
        }

        .editable-wrapper:hover .edit-icon {
            opacity: 1;
        }

        input:disabled,
        select:disabled,
        textarea:disabled,
        button:disabled {
            cursor: not-allowed !important;
        }

        .dataTables_empty {
            text-align: center;
            color: red;
        }

        .error {
            color: red;
        }

        .textcolorred {
            color: red;
        }

        span {
            border-color: black !important;
        }

        .card .card {
            border-color: black;
            box-shadow: none;
        }

        #vendorTable thead th {
            position: sticky;
            top: 0;
            /*background: #f8f9fa; /* สีพื้นหลังหัวตาราง */
            z-index: 1;
        }

        .table > :not(caption) > * > *, .markdown > table > :not(caption) > * > * {
            padding: 4px;
            color: var(--tblr-table-color-state, var(--tblr-table-color-type, var(--tblr-table-color)));
            background-color: var(--tblr-table-bg);
            border-bottom-width: var(--tblr-border-width);
            box-shadow: inset 0 0 0 9999px var(--tblr-table-bg-state, var(--tblr-table-bg-type, var(--tblr-table-accent-bg)));
        }

        .form-check-input[type=radio] {
            border-radius: 50%;
            border: 2px solid #000; /* เส้นวงกลมสีดำ */
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

            .form-check-input[type=radio]:checked {
                background-color: #000; /* จุดข้างในเป็นสีดำตอนเลือก */
                border-color: #000;
            }

        #tblDetail td textarea[name*="RemarkOfEditer"] {
            min-width: 300px; /* กำหนดความกว้างขั้นต่ำ */
        }


        /* Container for the search results dropdown */
        .search-results {
            position: absolute;
            z-index: 1000; /* ทำให้ dropdown อยู่บนสุด */
            width: calc(20% - 2px); /* กว้างเท่ากับ input */
            max-height: 200px; /* จำกัดความสูง */
            overflow-y: auto; /* มี scrollbar ถ้าเนื้อหาเกิน */
            border: 1px solid #ccc; /* เส้นขอบ */
            border-top: none; /* ไม่มีเส้นขอบด้านบน */
            border-radius: 0 0 .25rem .25rem; /* ขอบโค้งด้านล่าง */
            box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15); /* เงา */
            background-color: #fff; /* พื้นหลังสีขาว */
        }

        /* Style for each item in the dropdown */
        .list-group-item {
            position: relative;
            display: block;
            padding: .5rem 1rem;
            color: #212529;
            text-decoration: none;
            background-color: #fff;
            border-bottom: 1px solid rgba(0, 0, 0, .125) !important; /* เส้นแบ่งรายการ */
        }

        /* Hover and focus effect for clickable items */
        .list-group-item-action:hover,
        .list-group-item-action:focus {
            z-index: 5; /* ทำให้เส้นขอบไม่ถูกบัง */
            color: #212529;
            text-decoration: none;
            background-color: #f8f9fa !important; /* สีพื้นหลังเมื่อ hover */
        }

        /* Fix for the first item's top border */
        .list-group-item:first-child {
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
        }

        .list-group-item-action {
            width: 100% !important;
            color: var(--tblr-list-group-action-color);
            text-align: inherit;
        }

        .form-check-input[type=checkbox] {
            border: 2px solid #000;
            border-radius: var(--tblr-border-radius);
        }
    </style>
}
<div class="container-xl">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">@Model?.statusPageName</h3>
        </div>
        <div class="card-body">

            <!-- Row 1 -->
            <div class="row mb-1 align-items-center">
                <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">ประเภทการเบิก:</label>
                <div class="col-md-2 col-12 mb-2 mb-md-0">
                    @if (Model?.IsAdjust == true)
                    {
                    <span class="badge textcolorred"> ปรับ สต๊อค </span>

                    }
                    else
                    {
                        <span class="badge   @(Search?.TypeID == "001" ? "bg-orange " : "bg-green ")text-red-fg">@Search?.TypeIDName</span>

                    }
                    <input type="hidden" id="RequisitionType" value="@Search?.TypeID" />
                </div>
                <div class="col-md-2 d-none d-md-block"></div>
                <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">สถานะ </label>
                <div class="col-md-2 col-12">
                    @Model?.SYS_Status - @Model?.statusPageName
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">เลขที่ใบเบิกของ :</label>
                <div class="col-md-2 col-12 mb-2 mb-md-0">
                    <label class="form-control-plaintext" id="RunningID">@Model?.RunningID</label>
                </div>
                <div class="col-md-2 d-none d-md-block"></div>
                <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">
                    วันที่เบิกของ :
                </label>
                <div class="col-md-2 col-12">
                    <div class="input-group">
                        <span class="input-group-text"><i class="ti ti-calendar"></i></span>
                        <input type="text"
                               class="form-control DateInput"
                               placeholder="DD/MM/YYYY"
                               name="RequisitionDate"
                               value="@(string.IsNullOrEmpty(Model?.RequisitionDateTH) ? DateTime.Now.ToString("dd/MM/yyyy") : Model.RequisitionDateTH)"
                               @Disable
                               autocomplete="off">

                        @*<input type="text" class="form-control DateInput" placeholder="DD/MM/YYYY" name="ReceiveDate" value="@Model?.ReceivingDateTH" @Disable autocomplete="off">*@
                    </div>
                </div>
            </div>
            <div class="row mb-3 align-items-center">
                <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">
                    แผนกที่เขียนใบเบิก:
                </label>
                <div class="col-md-2 col-12 mb-2 mb-md-0">
                    <select class="form-select" name="DepartmentID" id="DepartmentID" disabled="@(DisableDDlType)" asp-items="@ViewBag.DepartmentID"><option value="">ทั้งหมด</option></select>

                </div>
                <div class="col-md-2 d-none d-md-block"></div>
                <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">
                    เลขที่ใบเบิกพัสดุ :
                </label>
                <div class="col-md-2 col-12">
                    <input type="text" class="form-control  " id="RequisitionNo" @Disable name="RequisitionNo" value="@Model?.RequisitionNo" placeholder="เลขที่ใบเบิกพัสดุ">

                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12 text-center">
                    @if (string.IsNullOrEmpty(Disable))
                    {
                        if (ViewBag.Edit)
                        {
                            <div class="d-flex justify-content-center flex-wrap gap-3">
                                <!-- ปุ่มเปิด Modal จากใบขอซื้อ -->
                                <button type="button"
                                        class="btn btn-md btn-green d-flex align-items-center px-4 py-2 shadow rounded-2"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalRequisitionFromPO">
                                    <i class="ti ti-file-invoice me-2 fs-5"></i> จากใบขอซื้อ
                                </button>

                                <!-- ปุ่มเปิด Modal จากสต็อคพัสดุ -->
                                <button type="button"
                                        class="btn btn-md btn-warning d-flex align-items-center px-4 py-2 shadow rounded-2"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modalFromStock">
                                    <i class="ti ti-box me-2 fs-5"></i> จากสต็อคพัสดุ
                                </button>
                            </div>}
                    }
                </div>
            </div>



            <div class="row mb-3">
                <div class="col-8">
                    <div class="d-flex align-items-center p-2">
                         
                        &nbsp; &nbsp; &nbsp;
                        <span>จำนวนทั้งหมด = @Model?.WH_PR_RequisitionDetail?.Count() รายการ</span>
                    </div>
                </div>
            </div>
            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover" id="tblDetail">
                    <thead>
                        <tr class="text-center">
                            <th>ItemOrder</th>
                            <th>รหัสสินค้า</th>
                            <th>ชื่อสินค้า</th>
                            <th>จำนวน</th>
                            <th>เบิก</th>
                            <th>หน่วย</th>
                            <th>หมายเหตุ</th>
                            <th>รหัสงาน</th>
                            <th>ชื่องาน</th>
                            <th> </th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model?.WH_PR_RequisitionDetail != null)
                        {
                            @foreach (var d in Model?.WH_PR_RequisitionDetail)
                            {
                                <tr class="text-center">
                                    <td>@d.ItemOrder</td>
                                    <td class="text-left">@d?.ItemID</td>
                                    <td class="text-start">@d?.WH_MT_ItemName?.ItemNameTH</td>
                                    <td class="text-right">@d?.Quantity</td>
                                    <td class="text-right">
                                         <input type="number"
                                               step="1"
                                               min="0"
                                               class="form-control form-control-sm text-right"
                                               value="@d?.QtyRequisition"
                                               name="QtyRequisition"
                                               @Disable />

                                    </td>
                                    <td>@d?.WH_MT_ItemName?.UnitNameTH</td>
                                    <td>
                                        <textarea class="form-control w-100" @Disable name="Remark"
                                                  rows="2" maxlength="200"
                                                  style="resize: vertical; overflow:auto;">@d?.Remark</textarea>
                                    </td>
                                    <td class="text-start">
                                        <div class="editable-wrapper position-relative d-inline-block w-100">
                                            <input type="text"
                                                   class="jobcode-input form-control-plaintext pe-4"
                                                   name="JobCode"
                                                   value="@d?.JobID"
                                                   readonly
                                                   placeholder="เลือกงาน..." />
                                            <i class="ti ti-search text-muted position-absolute end-0 top-50 translate-middle-y me-2 small search-icon color-orange"></i>
                                        </div>
                                    </td>
                                    <td class="text-start">
                                        <input type="text"
                                               class="form-control-plaintext jobname-display"
                                               value="@d?.V_WH_JobDepartment?.JobName"
                                               readonly />
                                    </td>
                                    <td>
                                        @if (string.IsNullOrEmpty(Disable))
                                        {
                                            if (ViewBag.Edit)
                                            {
                                                <button type="button" class="btn btn-danger btn-sm me-1 remove-row">
                                                    <i class="ti ti-trash"></i>
                                                </button>


                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        }


                    </tbody>
                </table>
            </div>
            @if (Model?.SYS_Status != null && Model?.SYS_Status != "P01" && Model?.SYS_Status != "C01")
            {
                <!-- ตรวจสอบใบรับของ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h3 class="card-title">ตรวจสอบใบรับของ</h3>
                    </div>
                    <div class="card-body" id="couseApprove1">

                        <!-- สถานะการอนุมัติ -->
                        <div class="mb-3 row">
                            <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">สถานะ:</label>
                            <div class="col-md-10 col-12">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" disabled="@(approve1)" name="Approve1Status" id="approve1" value="Y"
                                           @(Model?.Approve1Status == "Y" ? "checked" : "")>
                                    <label class="form-check-label text-success fw-bold" for="approve1">อนุมัติ</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" disabled="@(approve1)" name="Approve1Status" id="reject1" value="N"
                                           @(Model?.Approve1Status == "N" ? "checked" : "")>
                                    <label class="form-check-label text-danger fw-bold" for="reject1">ไม่อนุมัติ</label>
                                </div>
                            </div>
                        </div>


                        <!-- หมายเหตุ -->
                        <div class="mb-3 row">
                            <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">หมายเหตุ</label>
                            <div class="col-md-10 col-12">
                                <textarea class="form-control" disabled="@(Model?.SYS_Status != "P02" && Model?.SYS_Status != null ? true : false)" asp-for="@Model.Approve1Remark" id="Approve1Remark" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- ผู้อนุมัติและวันที่ -->
                        <div class="mb-3 row">
                            <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">ผู้อนุมัติ:</label>
                            <div class="col-md-4 col-12 col-form-label mb-2 mb-md-0">@Model?.Approve1Name</div>
                            <label class="col-md-2 col-12 col-form-label text-md-end mb-1 mb-md-0">วันที่:</label>
                            <div class="col-md-4 col-12 col-form-label">@Model?.Approve1DateTH</div>
                        </div>
                    </div>
                </div>
            }



            <!-- Buttons -->
            <div class="row mb-4 mt-4">
                <div class="col-12 d-flex justify-content-center">
                    <div class="btn-list">
                        @if ((Model?.SYS_Status == "P02" && ViewBag.approve1 == true))
                        {
                            <button type="button" class="btn btn-success" onclick="Approve('@Model?.RunningID','@Model?.SYS_Status')">
                                <i class="ti ti-device-floppy me-1"></i> บันทึก
                            </button>
                        }
                        else if ((Model?.SYS_Status == "P01" || string.IsNullOrEmpty(Model?.SYS_Status)) && ViewBag.Edit == true)
                        {
                            <button type="button" class="btn btn-success" onclick="Save('N');">
                                <i class="ti ti-device-floppy me-1"></i> บันทึก
                            </button>
                            <button type="button" class="btn btn-primary" onclick="Save('Y');">
                                <i class="ti ti-send me-1"></i> บันทึกและส่ง
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="Cancel()">
                                <i class="ti ti-trash"></i> ยกเลิก
                            </button>

                        }

                        @{
                            string closeUrl;

                            if (Search?.statusPage == "P05")
                            {
                                closeUrl = Url.Action("ListAs400", "Requisition", new { statusPage = "P05" });
                            }
                            else
                            {
                                var status = string.IsNullOrEmpty(Model?.SYS_Status)
                                             ? "P01"
                                             : (Search?.statusPage == "P01"
                                                ? Search?.statusPage
                                                : (string.IsNullOrEmpty(Search?.statusPage) ? Model?.SYS_Status : Search?.statusPage));

                                closeUrl = Url.Action("List", "Requisition", new { statusPage = status });
                            }
                        }
                        <a href="@closeUrl" class="btn btn-outline-danger btn-md waves-effect waves-light" role="button">ปิด หน้านี้</a>




                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal: เพิ่มจากใบขอซื้อ -->
<div class="modal fade" id="modalRequisitionFromPO" tabindex="-1" aria-labelledby="modalRequisitionFromPOLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header bg-green text-white">
                <h5 class="modal-title" id="modalRequisitionFromPOLabel">
                    <i class="ti ti-file-invoice me-2"></i> เพิ่มจากใบขอซื้อ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <!-- ฟอร์มค้นหา -->
                <div class="row mb-3 align-items-center">
                    <!-- ฝ่าย/แผนก -->
                    <div class="col-md-4">
                        <div class="form-group row">
                            <label class="col-4 col-form-label text-end">ฝ่าย/แผนก:</label>
                            <div class="col-8">
                                <select class="form-select" name="DepartmetModal" id="DepartmetModal" asp-items="@ViewBag.DepartmentID"><option value="">ทั้งหมด</option></select>

                            </div>
                        </div>
                    </div>

                    <!-- เลขที่ใบขอซื้อ -->
                    <div class="col-md-4">
                        <div class="form-group row">
                            <label class="col-5 col-form-label text-end">
                                เลขที่ใบขอซื้อ: <span class="text-danger">*</span>
                            </label>
                            <div class="col-7">
                                <input type="text"
                                       class="form-control"
                                       id="txtRequisitionNo"
                                       name="RequisitionNo"
                                       placeholder="เลขที่ใบขอซื้อ">
                            </div>
                        </div>
                    </div>

                    <!-- รหัส/ชื่อสินค้า -->
                    <div class="col-md-4">
                        <div class="form-group row">
                            <label class="col-5 col-form-label text-end">
                                รหัส/ชื่อสินค้า: <span class="text-danger">*</span>
                            </label>
                            <div class="col-7">
                                <input type="text"
                                       class="form-control"
                                       id="txtProductCode"
                                       name="ProductCode"
                                       placeholder="รหัส/ชื่อสินค้า">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- วันที่ -->
                <div class="row mt-3 g-3 align-items-center">
                    <!-- วันที่เริ่ม -->
                    <div class="col-md-2 text-end">
                        <label class="form-label">วันที่เบิก:</label>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="ti ti-calendar"></i></span>
                            <input type="text"
                                   class="form-control DateInput"
                                   id="txtDateStart"
                                   name="DateStart"
                                   placeholder="DD/MM/YYYY"
                                   autocomplete="off">
                        </div>
                    </div>

                    <!-- ถึง -->
                    <div class="col-md-1 text-center">
                        <label class="form-label">ถึง</label>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="ti ti-calendar"></i></span>
                            <input type="text"
                                   class="form-control DateInput"
                                   id="txtDateEnd"
                                   name="DateEnd"
                                   placeholder="DD/MM/YYYY"
                                   autocomplete="off">
                        </div>
                    </div>

                    <!-- ปุ่มค้นหา -->
                    <div class="col-md-3">
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" id="btnSearchPO" class="btn btn-blue d-flex align-items-center">
                                <i class="ti ti-search me-2"></i> ค้นหา
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ตาราง -->
                <div class="table-responsive mt-5" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-bordered table-striped table-hover">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th>เลือก</th>
                                <th>ฝ่าย/แผนก</th>
                                <th>เลขที่ใบขอซื้อ</th>
                                <th>รหัสสินค้า</th>
                                <th>ชื่อสินค้า</th>
                                <th>จำนวน</th>
                                <th>รับแล้ว</th>
                                <th>หน่วย</th>
                                <th>หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody id="tblPOList">
                            <!-- Rows จะ render ด้วย JS -->
                        </tbody>
                    </table>
                </div>

            </div>

            <!-- Footer -->
            <div class="modal-footer justify-content-center">
                <button type="button" id="btnAddPOItem" class="btn btn-green">
                    <i class="ti ti-plus me-1"></i> เพิ่มรายการ
                </button>
                <button type="button" class="btn btn-danger" id="btnCloseModal" data-bs-dismiss="modal">
                    <i class="ti ti-x me-1"></i> ปิด
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="jobModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="ti ti-briefcase"></i> เลือกรหัสงาน</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="jobSearchBox" class="form-control mb-3" placeholder="ค้นหางาน...">
                <div class="list-group" id="jobList">

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal จากสต็อคพัสดุ -->
<div class="modal fade" id="modalFromStock" tabindex="-1" aria-labelledby="modalFromStockLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="modalFromStockLabel">
                    <i class="ti ti-box me-2"></i> เพิ่มจากสต็อคพัสดุ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- ช่องค้นหา -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" id="txtSearchStock" class="form-control" placeholder="ค้นหาสินค้า...">
                            <button type="button" id="btnSearchStock" class="btn btn-blue">
                                <i class="ti ti-search"></i> ค้นหา
                            </button>                <button class="btn btn-secondary" id="btnCloseModalstock" data-bs-dismiss="modal">ปิด</button>

                        </div>
                    </div>
                </div>

                <!-- เนื้อหา -->
                <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>เลือก</th>
                                <th>รหัสสินค้า</th>
                                <th>ชื่อสินค้า</th>
                                <th>คงเหลือในสต๊อค</th>
                                <th>เบิก</th>
                                <th>หน่วย</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script src="~/dist/libs/litepicker/dist/litepicker.js"></script>
  

    <script>



        $(document).on('click', '.editable-input[readonly]', function () {
            $(this)
                .removeClass("form-control-plaintext")
                .addClass("form-control form-control-sm")
                .prop("readonly", false)
                .focus()
                .select();
        });

        $(document).on('blur', '.editable-input:not([readonly])', function () {
            $(this)
                .removeClass("form-control form-control-sm")
                .addClass("form-control-plaintext")
                .prop("readonly", true);
        });

        $(document).on('keydown', '.editable-input', function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                $(this).blur();
            } else if (e.key === "Escape") {
                $(this).blur();
            }
        });

        let currentInput = null;
        let id = null;

        // เปิด modal เมื่อคลิกช่องรหัสงาน

        $(document).on('click', '.jobcode-input', function () {
            if ($("#DepartmentID").val() == "") {
                showWarning("ระบุแผนกที่ขอซื้อ");
                return false;
            }
                currentInput = $(this); // เก็บ input ที่กดไว้
                $('#jobModal').modal('show');
            $('#jobResultTable tbody').empty(); // clear ตารางเดิม
            Search('');
            });



         $('#jobSearchBox').on('keyup', function () {
                let keyword = $(this).val().trim();

                if (keyword.length < 3) {
                    $('#jobList').html(''); // ล้างผลลัพธ์ถ้ายังไม่ถึง 3 ตัว
                    return;
                }
                Search(keyword);
            });


        function Search(keyword) {
                 $.get('@Url.Action("JobSearch", "Requisition")', { q: keyword }, function (res) {
                        let items = '';
                        if (res && res.length > 0) {
                            res.forEach(job => {
                                items += `
                                    <a href="#" class="list-group-item list-group-item-action select-job"
                                       data-code="${job.jobID}" data-name="${job.jobName}">
                                        ${job.jobID} - ${job.jobName}
                                    </a>`;
                            });
                        } else {
                            items = `<div class="list-group-item text-muted text-center">ไม่พบข้อมูล</div>`;
                        }
                        $('#jobList').html(items);
                    });
        }
// เลือกงาน
            $(document).on('click', '.select-job', function (e) {
                e.preventDefault();
                const code = $(this).data('code');
                const name = $(this).data('name');

                if (currentInput) {
                    currentInput.val(code);
                    currentInput.closest('tr').find('.jobname-display').val(name);
                }

                $('#jobModal').modal('hide');
            });








        // 🔹 เมื่อกดปุ่ม "เลือก" จากสต็อค
        $(document).on("click", ".btnSelectStock", function () {
                        let productID = $(this).data("id");
                        let code = $(this).data("code");
                        let name = $(this).data("name");
                        let qty = $(this).data("qty");
                        let unit = $(this).data("unit");
                        let remark = $(this).data("remark")  ;
                        let received = 1; // ค่า default เวลาเลือกมา

                        let rowIndex = $("#tblDetail tbody tr").length + 1;

                        let newRow = `
                                    <tr>
                                        <td class="text-center">${rowIndex}</td>
                                        <td class="text-center">${code}</td>
                                        <td>${name}</td>
                                        <td class="text-center">${qty}</td>
                                        <td class="text-right">
                                            <input type="number"
                                                   class="form-control form-control-sm text-center"
                                                   name="QtyRequisition"
                                                   value="${received}"
                                                   min="0"
                                                   max="${qty}" />
                                        </td>
                                        <td class="text-center">${unit}</td>
                                        <td>
                                            <textarea class="form-control w-100"
                                                      name="Remark"
                                                      rows="2"
                                                      maxlength="200"
                                                      style="resize: vertical; overflow:auto;"> </textarea>
                                        </td>
                                       <td class="text-start">
                                                <div class="editable-wrapper position-relative d-inline-block w-100">
                                                    <input type="text"
                                                           class="jobcode-input form-control-plaintext pe-4"
                                                           name="JobCode"

                                                           readonly
                                                           placeholder="เลือกงาน..." />
                                                    <i class="ti ti-search text-muted position-absolute end-0 top-50 translate-middle-y me-2 small search-icon color-orange"></i>
                                                </div>
                                            </td>
                                            <td class="text-start">
                                                <input type="text"
                                                       class="form-control-plaintext jobname-display"
                                                       readonly />
                                            </td>
                                        <td class="text-center">
                                              <button type="button" class="btn btn-danger btn-sm me-1 remove-row">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;

                        $("#tblDetail tbody").append(newRow);

                         $("#btnCloseModalstock").click(); // สมมติคุณเพิ่ม id ให้ปุ่มปิด
        });

        $(document).ready(function () {
            // กดปุ่มค้นหา
            $("#btnSearchStock").click(function () {
                var keyword = $("#txtSearchStock").val();
                ShowLoading();
                $.ajax({
                    url:  '@Url.Action("SearchStock", "Requisition")',   // 👉 Controller/Action ที่จะไปดึงข้อมูล
                    type: 'GET',
                    data: { keyword: keyword, RequisitionType: $("#RequisitionType").val() },
                    success: function (res) {
                        var rows = "";
                        $.each(res, function (i, item) {
                            rows += `
                            <tr>
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-warning btnSelectStock"
                                            data-id="${item.codeID}"
                                            data-code="${item.codeID}"
                                            data-name="${item.codeName}"
                                            data-qty="${item.totalQuantity}"
                                            data-unit="${item.unitNameTH}">
                                        เลือก
                                    </button>
                                </td>
                                <td>${item.codeID}</td>
                                <td>${item.codeName}</td>
                                <td class="text-center">${item.totalQuantity}</td>
                                <td><input type="number" class="form-control form-control-sm txtIssueQty" value="1" min="1" max="${item.totalQuantity}"></td>
                                <td>${item.unitNameTH}</td>
                            </tr>`;
                        });

                        $("#modalFromStock tbody").html(rows);
                        ShowLoading(false);
                    },
                    error: function () {
                        showWarning("เกิดข้อผิดพลาดในการค้นหา");
                        ShowLoading(false);
                    }
                });
            });
        });





        $('#tblDetail tbody').on('click', '.remove-row', function () {
            // Find the closest row (<tr>) and remove it
            $(this).closest('tr').remove();
        });
          function Save(s) {
            var send = false;
            if (s == "Y") { send = true; }
            var hasError = false;
            var details = [];
            $("#tblDetail tbody tr").each(function () {
                var row = $(this);
                var quantity = parseFloat(row.find("td:eq(3)").text().trim()) || 0;
                var qtyRequisition = parseFloat(row.find("input[name='QtyRequisition']").val()) || 0;
                if (qtyRequisition > quantity) {
                    hasError = true;
                    row.find("input[name='QtyRequisition']").addClass("is-invalid"); // highlight ช่องที่ผิด
                    errorMsg = "จำนวนที่ขอเบิก " + qtyRequisition + " ห้ามเกินจำนวนที่มีอยู่ " + quantity +"";
                } else {
                    row.find("input[name='QtyRequisition']").removeClass("is-invalid");
                }

                var detailItem = {
                    ItemOrder: row.find("td:eq(0)").text().trim(),
                    ItemID: row.find("td:eq(1)").text().trim(),
                    Quantity: quantity,
                    QtyRequisition: qtyRequisition,
                    Remark: row.find("textarea[name='Remark']").val(),
                    JobID: row.find('input[name="JobCode"]').val()
                }; 

                details.push(detailItem);
            });
            if (hasError) {
                showWarning(errorMsg);
                return false;
            }

              if ($("#DepartmentID").val() == "") {
                  showWarning("ระบุแผนกที่ขอซื้อ");
                  return false;
              }
            var item = {
                RunningID: $("#RunningID").html(),
                DepartmentID: $("#DepartmentID").val(),
                RequisitionDateStr: $("input[name ='RequisitionDate']").val(),
                RequisitionNo: $("#RequisitionNo").val(),
                RequisitionType: $("#RequisitionType").val(),
                SYS_Status: $("#SYS_Status").val(),
                WH_PR_RequisitionDetail: details,
                send: send,
            };
              var url = '@Url.Action("SaveRequisition", "Requisition")';
            // ส่งไป Controller
            $.ajax({
                url: url, // เปลี่ยนเป็น action ของคุณ
                type: 'POST',
                dataType: "json",
                data: item,
                beforeSend: function () {
                    ShowLoading();
                },
                success: function (res) {
                    if (res.success) {
                        let link = "";
                        if (send) {
                            link = '@Url.Action("List", "Requisition", new { statusPage = "P01" })';
                        } else if ($("#RunningID").html() != "") {
                            link = window.location.href;
                        } else {
                            link = '@Url.Action("Detail", "Requisition")' + "?ID=" + res.id;
                        }

                        showSuccess("บันทึกสำเร็จ", link);
                    } else {
                        showWarning("เกิดข้อผิดพลาดในการบันทึก" + res.ex);
                    }
                    ShowLoading(false);
                },
                error: function (err) {
                    showWarning("เกิดข้อผิดพลาดในการบันทึก" + err.ex );
                    ShowLoading(false);
                }
            });
        }

        $(document).ready(function () {


                    // 🔍 ปุ่มค้นหา
            $("#btnSearchPO").click(function () {
                ShowLoading();
                        let searchData = {
                            DepartmentID: $("#DepartmetModal").val(),
                            RequisitionNo: $("#txtRequisitionNo").val(),
                            ProductCode: $("#txtProductCode").val(),
                            DateStart: $("#txtDateStart").val(),
                            ReceivingType: $("#RequisitionType").val(),
                            DateEnd: $("#txtDateEnd").val()
                        };

                        $.ajax({
                            url: '@Url.Action("SearchRequisitionFromPO", "Requisition")',
                            type: "GET",
                            data: searchData,
                            beforeSend: function () {
                                $("#tblPOList").html(`<tr><td colspan="9" class="text-center">⏳ กำลังโหลด...</td></tr>`);
                            },
                            success: function (res) {
                                ShowLoading(false);
                                if (res && res.length > 0) {
                                    let rows = "";
                                    $.each(res, function (i, item) {
                                        rows += `
                                            <tr>
                                                <td class="text-center">
                                                   <input type="checkbox" class="form-check-input chkPOItem"
                                                           data-code="${item.productCode}"
                                                           data-name="${item.productName}"
                                                           data-qty="${item.quantity}"
                                                           data-received="${item.receivedQty}"
                                                           data-unit="${item.unitName}"
                                                           data-remark="${item.remark}" />
                                                </td>
                                                <td>${item.departmentName || ""}</td>
                                                <td>${item.requisitionNo || ""}</td>
                                                <td>${item.productCode || ""}</td>
                                                <td>${item.productName || ""}</td>
                                                <td class="text-end">${item.quantity != null ? item.quantity : 0}</td>
                                                <td class="text-end">${item.receivedQty != null ? item.receivedQty : 0}</td>
                                                <td>${item.unitName || ""}</td>
                                                <td>${item.remark || ""}</td>
                                            </tr>`;
                                    });
                                    $("#tblPOList").html(rows);
                                } else {
                                    $("#tblPOList").html(`<tr><td colspan="9" class="text-center text-muted">ไม่พบข้อมูล</td></tr>`);
                                }
                                ShowLoading(false);
                            },
                            error: function () {
                                $("#tblPOList").html(`<tr><td colspan="9" class="text-center text-danger">❌ เกิดข้อผิดพลาด</td></tr>`);
                                ShowLoading(false);
                            }
                        });
                    });

                    // ✅ เวลาเลือก checkbox ให้ highlight แถว
                    $(document).on("change", ".chkPOItem", function () {
                        if ($(this).is(":checked")) {
                            $(this).closest("tr").addClass("table-primary");
                        } else {
                            $(this).closest("tr").removeClass("table-primary");
                        }
                    });
                    let rowIndex = 0;
                    // ➕ ปุ่มเพิ่มรายการ
                    $("#btnAddPOItem").click(function () {
                        $(".chkPOItem:checked").each(function () {
                            rowIndex++;

                            let code = $(this).data("code");
                            let name = $(this).data("name");
                            let qty = $(this).data("qty");
                            let received = $(this).data("received");
                            let unit = $(this).data("unit");
                            let remark = $(this).data("remark");

                            let newRow = `
                                <tr>
                                    <td class="text-center">${rowIndex}</td>
                                    <td>${code}</td>
                                    <td>${name}</td>
                                    <td class="text-center">${qty}</td>
                                    <td><input type="number" class="form-control form-control-sm text-center"   name="QtyRequisition" value="${received}" /></td>
                                    <td>${unit}</td>
                                    <td> <textarea class="form-control w-100"  name="Remark"

                                              rows="2" maxlength="200"
                                              style="resize: vertical; overflow:auto;">${remark}</textarea></td>
                                    <td class="text-start">
                                                <div class="editable-wrapper position-relative d-inline-block w-100">
                                                    <input type="text"
                                                           class="jobcode-input form-control-plaintext pe-4"
                                                           name="JobCode"

                                                           readonly
                                                           placeholder="เลือกงาน..." />
                                                    <i class="ti ti-search text-muted position-absolute end-0 top-50 translate-middle-y me-2 small search-icon color-orange"></i>
                                                </div>
                                            </td>
                                            <td class="text-start">
                                                <input type="text"
                                                       class="form-control-plaintext jobname-display"
                                                       readonly />
                                            </td>
                                    <td class="text-center"> <button type="button" class="btn btn-danger btn-sm me-1 remove-row">
                                                <i class="ti ti-trash"></i>
                                            </button></td>
                                </tr>
                            `;
                            $("#tblDetail tbody").append(newRow);
                        });


                        // ปิด modal แบบ Bootstrap 5 ถูกต้อง
                        $("#btnCloseModal").click(); // สมมติคุณเพิ่ม id ให้ปุ่มปิด
                    });
                });




    </script>


    <script>
        document.body.addEventListener('focusin', function (e) {
            if (e.target.classList.contains('DateInput') && !e.target.dataset.hasLitepicker) {
                const picker = new Litepicker({
                    element: e.target,
                    format: 'DD/MM/YYYY',
                    lang: 'th',
                    autoApply: true,
                    singleMode: true, // สำคัญ ให้เลือกแค่ 1 วัน
                    dropdowns: {
                        minYear: 2000,
                        maxYear: new Date().getFullYear() + 5,
                        months: true,
                        years: true
                    }
                });

                // Update value ของ input เวลาผู้ใช้เลือก
                picker.on('selected', function (date1, date2) {
                    e.target.value = date1.format('DD/MM/YYYY');
                });

                e.target.dataset.hasLitepicker = 'true';
            }
        });
            function Approve(id,sys){
                    let status = $("input[name='Approve1Status']:checked").val();
                    let remark = $("#Approve1Remark").val();
                    let runningId = id; // สมมติว่า id อยู่ใน span หรือ hidden input
                    if (!status) {
                        showWarning("กรุณาเลือกสถานะการอนุมัติ");
                        return;
                    }
                    $.ajax({
                        url: '@Url.Action("Approve", "Requisition")',
                        type: "POST",
                        data: {
                            RunningID: runningId,
                            sys: sys,
                            Approve1Status: status,
                            Approve1Remark: remark
                        },
                        success: function (res) {
                            if (res.success) {
                                var link = '@Url.Action("List", "Requisition", new { statusPage = "P01"  })';
                                showSuccess("บันทึกสำเร็จ", link);
                            } else {
                                showWarning("เกิดข้อผิดพลาด: " + res.error);
                            }
                        },
                        error: function (xhr, status, error) {
                            showWarning("Error: " + error);
                        }
                    });
            };


    </script>
}
