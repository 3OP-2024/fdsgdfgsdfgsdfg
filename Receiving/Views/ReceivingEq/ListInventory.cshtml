@model GFPT.Extension.Paging.Std20.HelperPaging<Receiving.Models.HR_PR_EquipmentInventory>
@{
    Receiving.Models.Search Search = ViewBag.Search ?? null;
    var TotalItems = Model?.TotalItems;
}
@section Css{
    <style>
        .color-green {
            color: green !important;
        }

        .color-brown {
            color: saddlebrown !important;
        }

        span {
            border-color: black !important;
        }
    </style>
}
<div class="container-xl mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">@ViewData["Title"]</h3>
                </div>
                <div class="card-body">
                    <form method="get" id="formSearch">
                        <input type="hidden" id="statusPage" name="statusPage" value="@Search.statusPage" />
                        <input type="hidden" id="page" name="page" />
                        <input type="hidden" id="sorting" name="sorting" value="@Search.sorting" />
                        <input type="hidden" id="currentSort" name="currentSort" value="@ViewBag.CurrentSort" />
                        <!-- กลุ่มที่ 1 -->
                        <div class="row g-3 align-items-center">
                            <div class="col-md-1 text-end">
                                <label class="form-label w-100">Serial No. :</label>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control" name="SerialNo" value="@Search.SerialNo" autocomplete="off">
                            </div>

                            <div class="col-md-1 text-end">
                                <label class="form-label w-100">รหัส/ชื่อสินค้า :</label>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control" name="critiria" value="@Search.critiria" autocomplete="off">
                            </div>

                            <div class="col-md-1 text-end">
                                <label class="form-label w-100">Location :</label>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control" name="Location" value="@Search.Location" autocomplete="off">
                            </div>

                            <div class="col-md-3 text-start">
                                <button type="submit" class="btn btn-info me-1">
                                    <i class="ti ti-search"></i> ค้นหา
                                </button>
                                <a href='@Url.Action("Index","Home")' class="btn waves-effect waves-light    btn-outline-danger" role="button"><i class="mdi mdi-close-circle-outline"></i> ปิดหน้านี้</a>

                            </div>
                        </div>

                        <!-- กลุ่มที่ 2 -->
                        <div class="row mt-3 g-3 align-items-center">
                            <div class="col-md-1 text-end">
                                <label class="form-label w-100">วันที่จัดเก็บ :</label>
                            </div>
                            <div class="col-md-2">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="ti ti-calendar"></i></span>
                                    <input type="text" class="form-control DateInput" placeholder="DD/MM/YYYY" name="receiveDateStart" value="@Search.receiveDateStart" autocomplete="off">
                                </div>
                            </div>
                            <div class="col-md-1 text-center">
                                <label class="form-label w-100">ถึง</label>
                            </div>
                            <div class="col-md-2 text-start">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="ti ti-calendar"></i></span>
                                    <input type="text" class="form-control DateInput" placeholder="DD/MM/YYYY" name="receiveDateEnd" value="@Search.receiveDateEnd" autocomplete="off">
                                </div>

                            </div>

                            <div class="col-md-1 text-end">
                                <label class="form-label w-100">ประเภทการรับ :</label>
                            </div>
                            <div class="col-md-2">
                                <select id="TypeID" name="TypeID" class="form-select" asp-items="@ViewBag.TypeID">
                                    <option value="">ทั้งหมด</option>
                                </select>

                            </div>

                            <div class="col-md-3 text-start">
                                <button type="button" class="btn btn-brown" onclick="Send();">
                                    <i class="ti ti-device-floppy me-1"></i> จัดเก็บ
                                </button>
                            </div>
                        </div>
                    </form>



                    <div class="mt-4 mb-3">
                        <span>แสดงทั้งหมด <strong>@Model?.Items?.Count()</strong> รายการ จาก <strong>@Model?.TotalItems</strong> รายการ</span>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr class="text-center">
                                    <th>
                                        <input type="checkbox" id="selectAll" />
                                    </th>
                                    <th>Serial No.</th>
                                    <th>ประเภทการรับ</th>
                                    <th>รหัสสินค้า</th>
                                    <th>ชื่อสินค้า</th>
                                    <th>Lot No.</th>
                                    <th>จำนวน</th>
                                    <th>หน่วย</th>
                                    <th>วันหมดอายุ</th>
                                    <th>เลขที่ใบตรวจสอบ</th>
                                    <th>Location</th>
                                    <th>เลขที่รับของ</th>
                                    <th>ผู้บันทึก</th>
                                    <th>วันที่บันทึก</th>
                                    <th>สถานะ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model?.Items != null)
                                {
                                    @foreach (var item in Model.Items)
                                    {
                                        <tr>
                                            <td class="text-center">
                                                @if (item.SYS_Status == "P02")
                                                {
                                                    <input type="checkbox" class="rowCheckbox" value="@item.SerialNo" />

                                                }
                                            </td>
                                            <td class="text-left  ">
                                                @item?.SerialNo
                                            </td>
                                            <td class="text-left @(item.ReceivingType == "001" ?  "color-orange" : "color-green" )  ">@item?.TypeIDName</td>
                                            <td class="text-left  ">
                                                @item?.CodeID
                                            </td>
                                            <td class="text-left  ">
                                                @item?.CodeName
                                            </td>
                                            <td class="text-left  ">
                                                @item?.LotNo
                                            </td>
                                            <td class="text-left  ">
                                                @item?.QtyReceived
                                            </td>
                                            <td class="text-left  ">
                                                @item?.Unit
                                            </td>
                                            <td class="text-left  ">
                                                @item?.ExpireDate
                                            </td>
                                            <td class="text-left  ">
                                                @if (string.IsNullOrEmpty(item?.CheckSheetNo))
                                                {
                                                    <button class="btn btn-sm btn-outline-primary"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#modalCheckSheetNo"
                                                            data-serial="@item.SerialNo">
                                                        <i class="ti ti-map-pin-plus me-1"></i> Add เลขที่ใบตรวจสอบ
                                                    </button>
                                                }
                                                else
                                                {
                                                    @item?.CheckSheetNo
                                                }
                                            </td>
                                            <td class="text-left  ">
                                                @if (string.IsNullOrEmpty(item?.LocationID))
                                                {
                                                    <button class="btn btn-sm btn-outline-primary"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#modalAddLocation"
                                                            data-serial="@item.SerialNo">
                                                        <i class="ti ti-map-pin-plus me-1"></i> Add Location
                                                    </button>
                                                }
                                                else
                                                {
                                                    @item?.HR_PR_EquipmentLocation?.LocationIDAndName
                                                }
                                            </td>
                                            <td class="text-left  ">
                                                <a asp-action="Detail" asp-route-ID="@item.RunningID" asp-route-statusPage="@Search.statusPage" class="triggerLoadding">@item.RunningID</a>
                                            </td>
                                            <td class="text-left  ">
                                                @item?.CreateName
                                            </td>
                                            <td class="text-left  ">
                                                @item?.CreateDate
                                            </td>
                                            <td class="text-left  @(item?.Color_Status) ">

                                                &nbsp; &nbsp; @item.SYS_Status-@item.statusPageName
                                            </td>
                                        </tr>
                                    }
                                }


                            </tbody>
                        </table>
                    </div>

                    @*@if (Model?.EndPage > 1)
                        {
                            <div class="mt-3">
                                <ul class="pagination">
                                    @if (Model.CurrentPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" onclick="SearchByPage('1');">หน้าแรก</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" onclick="SearchByPage('@(Model.PreviousPage)');">ย้อนกลับ</a>
                                        </li>
                                    }
                                    @for (var page = Model.StartPage; page <= Model.EndPage; page++)
                                    {
                                        <li class="page-item @(page == Model.CurrentPage ? "active" : "")">
                                            <a class="page-link" onclick="SearchByPage('@page');">@page</a>
                                        </li>
                                    }
                                    @if (Model?.CurrentPage < Model?.TotalPages)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" onclick="SearchByPage('@(Model.NextPage)');">หน้าต่อไป</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" onclick="SearchByPage('@(Model.TotalPages)');">หน้าสุดท้าย</a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }*@

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddLocation" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title"><i class="ti ti-map-pin-plus me-2"></i> เลือก Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ค้นหา Location</label>
                    <input type="text" id="searchLocation" class="form-control" placeholder="พิมพ์รหัสหรือชื่อ Location">
                </div>

                <div id="locationList" class="d-flex flex-wrap gap-2">
                    
                </div>
            </div>

            <div class="modal-footer">
                <input type="hidden" id="selectedSerialNo" /> 
                <button type="button" class="btn btn-warning" data-bs-dismiss="modal">ปิด</button>

            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="modalCheckSheetNo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ระบุ เลขที่ใบตรวจสอบ</label>
                    <input type="text" id="CheckNo" class="form-control">
                </div>
            </div>

            <div class="modal-footer justify-content-center">
                <input type="hidden" id="selectedSerialNoCheckNo" />
                <button type="button" class="btn btn-brown" onclick="SaveCheckNo();">
                    <i class="ti ti-device-floppy me-1"></i> บันทึก
                </button>
                <button type="button" class="btn btn-warning" data-bs-dismiss="modal">ปิด</button>

            </div>

        </div>
    </div>
</div>

@section scripts {
    <script src="~/dist/libs/litepicker/dist/litepicker.js"></script>


   <script>
       function SaveCheckNo() {
           var serialNo = $('#selectedSerialNoCheckNo').val();
           var checkNo = $('#CheckNo').val().trim();

           // Validation
           if (!checkNo) {
               showWarning("กรุณากรอกเลขที่ใบตรวจสอบ");
               $('#CheckNo').focus();
               return;
           }

           // ส่ง AJAX ไป C# Controller
           $.ajax({
               url: '@Url.Action("SaveCheckSheetNo", "ReceivingEq")', // action สำหรับค้นหา Location 
               type: 'POST',
               data: { SerialNo: serialNo, CheckNo: checkNo }, // ไม่ต้อง JSON.stringify
               dataType: "json",
               success: function (response) {
                   if (response.success) {
                       showSuccess("บันทึกเรียบร้อยแล้ว");
                       location.reload(); // หรืออัปเดตเฉพาะ row
                       // ปิด modal
                       var modalEl = document.getElementById('modalCheckSheetNo');
                       var modalInstance = bootstrap.Modal.getInstance(modalEl);
                       modalInstance.hide();

                       // เคลียร์ input
                       $('#CheckNo').val('');
                       $('#selectedSerialNoCheckNo').val('');

                       // TODO: อัพเดต UI ถ้าจำเป็น
                   } else {
                       showWarning("เกิดข้อผิดพลาด: " + response.message);
                   }
               },
               error: function (xhr, status, error) {
                   console.error(error);
                   showWarning("เกิดข้อผิดพลาดระหว่างบันทึก");
               }
           });
       }


       let currentSerialNo = null;

           $(document).ready(function () { 
                     
                    function setupModal(modalId, hiddenInputId, clearActiveBtn = false) {
                        var modalEl = document.getElementById(modalId);
                        var modalInstance = new bootstrap.Modal(modalEl);

                        // ดักทุกปุ่มที่เปิด modal
                        $('button[data-bs-toggle="modal"][data-bs-target="#' + modalId + '"]').on('click', function () {
                            var serialNo = $(this).data('serial');
                            $('#' + hiddenInputId).val(serialNo);

                            if (clearActiveBtn) {
                                $('#' + modalId + ' #locationList button').removeClass('active');
                            }

                            modalInstance.show();
                        });

                        // เคลียร์ค่าเมื่อ modal ปิด
                        modalEl.addEventListener('hidden.bs.modal', function () {
                            if (clearActiveBtn) {
                                $('#' + modalId + ' #locationList button').removeClass('active');
                            }
                            $('.modal-backdrop').remove(); // ป้องกัน backdrop ค้าง
                        });
                    }

                    // ตั้งค่า modal แต่ละตัว
                    setupModal('modalAddLocation', 'selectedSerialNo', true);
                    setupModal('modalCheckSheetNo', 'selectedSerialNoCheckNo', false);
                });




       // พิมพ์ค้นหา Location
      $("#searchLocation").on("input", function () {
                let query = $(this).val().trim();
                if (!query) {
                    $("#locationList").html('');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("SearchLocation", "ReceivingEq")', // action สำหรับค้นหา Location 
                    type: 'GET',
                    data: { keyword: query },
                    success: function (res) {
                        let html = '';
                        if (res && res.length > 0) {
                            html += '<div class="d-flex flex-wrap gap-2">';
                
                            // สีที่จะวนใช้
                            const colors = [
                                "btn-outline-primary",
                                "btn-outline-success",
                                "btn-outline-warning",
                                "btn-outline-info",
                                "btn-outline-secondary"
                            ];

                            res.forEach((loc, i) => {
                                let colorClass = colors[i % colors.length]; // สลับสีตาม index
                                html += `<button type="button" class="btn ${colorClass}" onclick="selectLocation('${loc.locationID}','${loc.name}')">
                                            ${loc.locationID} - ${loc.name}
                                         </button>`;
                            });

                            html += '</div>';
                        } else {
                            html = '<div class="text-muted">ไม่พบ Location</div>';
                        }
                        $("#locationList").html(html);
                    }
                });
            });

 

      // คลิกเลือก Location => แสดง popup ยืนยันก่อนบันทึก
            function selectLocation(locationId,name) {
                let serialNo = $("#selectedSerialNo").val();

                Swal.fire({
                    title: 'ยืนยันการบันทึก?',
                    text: `คุณต้องการบันทึก Location: ${locationId}${name}  สำหรับ Serial: ${serialNo} ใช่หรือไม่?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'บันทึก',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // ถ้ายืนยัน -> ค่อยยิง AJAX ไปบันทึก
                        $.ajax({
                            url: '@Url.Action("SaveLocation", "ReceivingEq")',
                            type: 'POST',
                            data: { locationId: locationId, serialNo: serialNo },
                            dataType: "json",
                            beforeSend: function () { ShowLoading(); },
                            success: function (res) {
                                if (res.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'บันทึกสำเร็จ',
                                        timer: 1000,
                                        showConfirmButton: false
                                    }).then(() => {
                                        $("#modalAddLocation").modal('hide');
                                        location.reload(); // หรืออัปเดตเฉพาะ row
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'เกิดข้อผิดพลาด',
                                        text: res.message || ''
                                    });
                                }
                            },
                            complete: function () { ShowLoading(false); }
                        });
                    }
                });
            } 
    </script> 


    <script>

        function Send() {
            // ดึง RunningID ที่ถูกเลือก
            let selectedIds = [];
            $(".rowCheckbox:checked").each(function () {
                selectedIds.push($(this).val());
            });

            if (selectedIds.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกอย่างน้อย 1 รายการ',
                });
                return;
            }

            // ยืนยันก่อนส่งข้อมูล
            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: "รายการที่เลือกจะถูกส่งไปจัดเก็บ!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ส่งข้อมูลไป backend
                    $.ajax({
                     url: '@Url.Action("SendInventory", "ReceivingEq")',

                        type: 'POST',

                        data: JSON.stringify(selectedIds), // ✅ ส่ง array ตรง ๆ
                        contentType: 'application/json; charset=utf-8',
                        beforeSend: function () { ShowLoading(); },
                        success: function (res) {
                            if (res.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'อัปเดทสำเร็จ',
                                    text: res.message || ''
                                }).then(() => {
                                    location.reload(); // รีเฟรชหน้าหรือทำอย่างอื่น
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'เกิดข้อผิดพลาด',
                                    text: res.message || ''
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: 'ไม่สามารถติดต่อเซิร์ฟเวอร์ได้'
                            });
                        },
                        complete: function () { ShowLoading(false); }
                    });
                }
            });
        }




        // ฟังก์ชัน select all
        $(document).on("change", "#selectAll", function () {
            $(".rowCheckbox").prop("checked", $(this).prop("checked"));
        });

        // ถ้าเอา checkbox บางอันออก ให้ uncheck selectAll
        $(document).on("change", ".rowCheckbox", function () {
            if ($(".rowCheckbox:checked").length === $(".rowCheckbox").length) {
                $("#selectAll").prop("checked", true);
            } else {
                $("#selectAll").prop("checked", false);
            }
        });

        // ตัวอย่างการดึงค่าที่เลือกไปใช้งาน
        function getSelectedIds() {
            let ids = [];
            $(".rowCheckbox:checked").each(function () {
                ids.push($(this).val());
            });
            return ids;
        }
        document.querySelectorAll('.DateInput').forEach(function (el) {
            new Litepicker({
                element: el,
                format: 'DD/MM/YYYY',
                lang: 'th',
                autoApply: true,
                dropdowns: {
                    minYear: 2000,
                    maxYear: new Date().getFullYear() + 5,
                    months: true,
                    years: true
                },
                setup: (picker) => {
                    picker.on('render', () => {
                        // เพิ่ม class สำหรับแต่งสีเอง
                        document.querySelectorAll('.litepicker').forEach(el => {
                            el.classList.add('custom-datepicker-style');
                        });
                    });
                }
            });
        });
      var status = "";
        function SearchByPage(pager) {
           let critiria = $("#critiria").val();
             let usestatus = $("#usestatus").val();
             var url = '@Url.Action("ListMasterProduct", "Sticker")?critiria=' + critiria + "&usestatus=" + usestatus + "&page=" + pager ;
             ShowLoading();
             window.location.replace(url);
        }


    </script>
}